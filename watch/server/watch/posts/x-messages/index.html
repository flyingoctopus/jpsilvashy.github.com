<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">

  <title>X-Messages</title>
  <meta name="author" content="Joseph Silvashy">
  <link href="http://feeds.feedburner.com/jpsilvashy" rel="alternate" title="Joseph Silvashy" type="application/atom+xml" />

  <link rel="stylesheet" href="/stylesheets/compiled/styles.css">
  <link rel="stylesheet" href="/stylesheets/compiled/prettify.css">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>
<body>
  <div class="wrapper">
    <header>
      <h1><a href="/">Joseph Silvashy</a></h1>
      <p>Building web applications and businesses.</p>
    </header>

    <section>
      <div id="post">
  <h1>X-Messages</h1>
  <p class="meta"></p>

  <div class='callout github'>
  An example application for this post is available <a href='http://github.com/jpsilvashy/x-messages'>on Github</a>. The application itself is deployed <a href='http://x-messages.herokuapp.com'>on Heroku</a>.
  <svg class='octocat' viewBox='-0.2 -1 379 334' xmlns='http://www.w3.org/2000/svg'>
 <path d='m296.94 295.43c0 20.533-47.56 37.176-106.22 37.176-58.67 0-106.23-16.643-106.23-37.176s47.558-37.18 106.23-37.18c58.66 0 106.22 16.65 106.22 37.18z' fill='#9CDAF1' id='puddle' />
  <g fill='#7DBBE6' id='shadow-legs'>
    <path d='m161.85 331.22v-26.5c0-3.422-.619-6.284-1.653-8.701 6.853 5.322 7.316 18.695 7.316 18.695v17.004c6.166.481 12.534.773 19.053.861l-.172-16.92c-.944-23.13-20.769-25.961-20.769-25.961-7.245-1.645-7.137 1.991-6.409 4.34-7.108-12.122-26.158-10.556-26.158-10.556-6.611 2.357-.475 6.607-.475 6.607 10.387 3.775 11.33 15.105 11.33 15.105v23.622c5.72.98 11.71 1.79 17.94 2.4z' />
    <path d='m245.4 283.48s-19.053-1.566-26.16 10.559c.728-2.35.839-5.989-6.408-4.343 0 0-19.824 2.832-20.768 25.961l-.174 16.946c6.509-.025 12.876-.254 19.054-.671v-17.219s.465-13.373 7.316-18.695c-1.034 2.417-1.653 5.278-1.653 8.701v26.775c6.214-.544 12.211-1.279 17.937-2.188v-24.113s.944-11.33 11.33-15.105c0-.01 6.13-4.26-.48-6.62z' />
  </g>
  <path d='m378.18 141.32l.28-1.389c-31.162-6.231-63.141-6.294-82.487-5.49 3.178-11.451 4.134-24.627 4.134-39.32 0-21.073-7.917-37.931-20.77-50.759 2.246-7.25 5.246-23.351-2.996-43.963 0 0-14.541-4.617-47.431 17.396-12.884-3.22-26.596-4.81-40.328-4.81-15.109 0-30.376 1.924-44.615 5.83-33.94-23.154-48.923-18.411-48.923-18.411-9.78 24.457-3.733 42.566-1.896 47.063-11.495 12.406-18.513 28.243-18.513 47.659 0 14.658 1.669 27.808 5.745 39.237-19.511-.71-50.323-.437-80.373 5.572l.276 1.389c30.231-6.046 61.237-6.256 80.629-5.522.898 2.366 1.899 4.661 3.021 6.879-19.177.618-51.922 3.062-83.303 11.915l.387 1.36c31.629-8.918 64.658-11.301 83.649-11.882 11.458 21.358 34.048 35.152 74.236 39.484-5.704 3.833-11.523 10.349-13.881 21.374-7.773 3.718-32.379 12.793-47.142-12.599 0 0-8.264-15.109-24.082-16.292 0 0-15.344-.235-1.059 9.562 0 0 10.267 4.838 17.351 23.019 0 0 9.241 31.01 53.835 21.061v32.032s-.943 11.33-11.33 15.105c0 0-6.137 4.249.475 6.606 0 0 28.792 2.361 28.792-21.238v-34.929s-1.142-13.852 5.663-18.667v57.371s-.47 13.688-7.551 18.881c0 0-4.723 8.494 5.663 6.137 0 0 19.824-2.832 20.769-25.961l.449-58.06h4.765l.453 58.06c.943 23.129 20.768 25.961 20.768 25.961 10.383 2.357 5.663-6.137 5.663-6.137-7.08-5.193-7.551-18.881-7.551-18.881v-56.876c6.801 5.296 5.663 18.171 5.663 18.171v34.929c0 23.6 28.793 21.238 28.793 21.238 6.606-2.357.474-6.606.474-6.606-10.386-3.775-11.33-15.105-11.33-15.105v-45.786c0-17.854-7.518-27.309-14.87-32.3 42.859-4.25 63.426-18.089 72.903-39.591 18.773.516 52.557 2.803 84.873 11.919l.384-1.36c-32.131-9.063-65.692-11.408-84.655-11.96.898-2.172 1.682-4.431 2.378-6.755 19.25-.80 51.38-.79 82.66 5.46z' id='cat' />
  <path d='m258.19 94.132c9.231 8.363 14.631 18.462 14.631 29.343 0 50.804-37.872 52.181-84.585 52.181-46.721 0-84.589-7.035-84.589-52.181 0-10.809 5.324-20.845 14.441-29.174 15.208-13.881 40.946-6.531 70.147-6.531 29.07-.004 54.72-7.429 69.95 6.357z' fill='#F4CBB2' id='face' />
  <path d='m160.1 126.06 c0 13.994-7.88 25.336-17.6 25.336-9.72 0-17.6-11.342-17.6-25.336 0-13.992 7.88-25.33 17.6-25.33 9.72.01 17.6 11.34 17.6 25.33z m94.43 0 c0 13.994-7.88 25.336-17.6 25.336-9.72 0-17.6-11.342-17.6-25.336 0-13.992 7.88-25.33 17.6-25.33 9.72.01 17.6 11.34 17.6 25.33z' fill='#FFF' id='eyes' />
  <g fill='#AD5C51'>
    <path d='m154.46 126.38 c0 9.328-5.26 16.887-11.734 16.887s-11.733-7.559-11.733-16.887c0-9.331 5.255-16.894 11.733-16.894 6.47 0 11.73 7.56 11.73 16.89z m94.42 0 c0 9.328-5.26 16.887-11.734 16.887s-11.733-7.559-11.733-16.887c0-9.331 5.255-16.894 11.733-16.894 6.47 0 11.73 7.56 11.73 16.89z' id='pupils' />
    <circle cx='188.5' cy='148.56' id='nose' r='4.401' />
    <path d='m178.23 159.69c-.26-.738.128-1.545.861-1.805.737-.26 1.546.128 1.805.861 1.134 3.198 4.167 5.346 7.551 5.346s6.417-2.147 7.551-5.346c.26-.738 1.067-1.121 1.805-.861s1.121 1.067.862 1.805c-1.529 4.324-5.639 7.229-10.218 7.229s-8.68-2.89-10.21-7.22z' id='mouth' />
  </g>
  <path d='m80.641 179.82 c0 1.174-1.376 2.122-3.07 2.122-1.693 0-3.07-.948-3.07-2.122 0-1.175 1.377-2.127 3.07-2.127 1.694 0 3.07.95 3.07 2.13z m8.5 4.72 c0 1.174-1.376 2.122-3.07 2.122-1.693 0-3.07-.948-3.07-2.122 0-1.175 1.377-2.127 3.07-2.127 1.694 0 3.07.95 3.07 2.13z m5.193 6.14 c0 1.174-1.376 2.122-3.07 2.122-1.693 0-3.07-.948-3.07-2.122 0-1.175 1.377-2.127 3.07-2.127 1.694 0 3.07.95 3.07 2.13z m4.72 7.08 c0 1.174-1.376 2.122-3.07 2.122-1.693 0-3.07-.948-3.07-2.122 0-1.175 1.377-2.127 3.07-2.127 1.694 0 3.07.95 3.07 2.13z m5.188 6.61 c0 1.174-1.376 2.122-3.07 2.122-1.693 0-3.07-.948-3.07-2.122 0-1.175 1.377-2.127 3.07-2.127 1.694 0 3.07.95 3.07 2.13z m7.09 5.66 c0 1.174-1.376 2.122-3.07 2.122-1.693 0-3.07-.948-3.07-2.122 0-1.175 1.377-2.127 3.07-2.127 1.694 0 3.07.95 3.07 2.13z m9.91 3.78 c0 1.174-1.376 2.122-3.07 2.122-1.693 0-3.07-.948-3.07-2.122 0-1.175 1.377-2.127 3.07-2.127 1.694 0 3.07.95 3.07 2.13z m9.87 0 c0 1.174-1.376 2.122-3.07 2.122-1.693 0-3.07-.948-3.07-2.122 0-1.175 1.377-2.127 3.07-2.127 1.694 0 3.07.95 3.07 2.13z m10.01 -1.64 c0 1.174-1.376 2.122-3.07 2.122-1.693 0-3.07-.948-3.07-2.122 0-1.175 1.377-2.127 3.07-2.127 1.694 0 3.07.95 3.07 2.13z' fill='#C3E4D8' id='octo' />
  <path d='m69.369 186.12l-3.066 10.683s-.8 3.861 2.84 4.546c3.8-.074 3.486-3.627 3.223-4.781z' fill='#9CDAF1' id='drop' />
</svg>

</div>
<h2 id='using_headers_to_provide_additional_response_information'>Using headers to provide additional response information</h2>

<p>While working on <a href='http://flyer.io'>Flyer</a>, I wanted to try something different with handling flash messages. I&#8217;ve always wanted to get more creative with the usage of response headers so I decided to try to use those as a transport for the flash messages typically handled in the views by just rendering some html messages at the top of the page.</p>

<p>If you&#8217;d like to checkout the &#8220;mostly&#8221; working example, head over to <a href='http://github.com/jpsilvashy/x-messages'>github.com/jpsilvashy/x-headers</a>, or check out the app running on heroku at <a href='http://x-messages.herokuapp.com'>x-messages.herokuapp.com</a>.</p>

<h3 id='why_you_should_just_render_some_javascript_in_the_response_body_instead'>Why? You should just render some JavaScript in the response body instead!</h3>

<p>So the biggest reason why I wanted to sort of ignore the &#8220;Rails Way&#8221; on this one is to try to extend the functionality beyond a rails application. The major idea here is that we can use a header named <code>X-Messages</code> to deliver more universal information about the response. I feel there is so much more informtion than just a 200 status that should be represented in a familiar place amongts all HTTP applications.</p>

<p>By using a common header like <code>X-Messages</code> all our applications can send additional response information for any format, not just HTML or JSON. Lastly our clients will all know to look in a specific place for any sort of request.</p>

<p>In this example I&#8217;ve built a Rails application which returns the <code>X-Messages</code> header with the same information that <code>ActionController::Flash</code> would via the <code>flash</code> method.</p>

<p>There isn&#8217;t much to it, and it won&#8217;t affect the current functionality of you app either, add this to your <code>application_controller.rb</code>:</p>
<pre class='prettyprint lang-ruby'>
# After filter to insert the headers in the response
after_filter :x_messages

# Also make available as a helper so we can render
# the errors of the user doesn't have js
helper_method :x_messages

private

# If there is a flash present, insert into header
def x_messages
  if flash.present?
    response.headers['X-Messages'] = flash.to_hash.to_json
    flash.to_hash
  end
end
</pre>
<p>Then in your view you can do a variety of things, I created a helper which would render the errors at the top of the page if the user doesn&#8217;t have JS (in the case where the client is obviously a web browser), but we also render an array of the same objects in the JS near the bottom of the page so we can just access that when the DOM is ready.</p>

<p>Here is the helper I made to render the messages in the page for the users which don&#8217;t have JS:</p>
<pre class='prettyprint lang-ruby'>
def render_x_messages
  if x_messages
    content_tag :ul, :class => 'x-messages' do
      x_messages.collect do |type, message|
        concat content_tag(
          :li, message, :class => "message-#{type}"
        )
      end
    end
  end
end
</pre>
<p>Put that helper anywhere in your layout where you want to render the messages. Then by the footer I&#8217;m also inserting some JavaScript for us to iterate over in our JS after the page loads.</p>
<pre class='prettyprint lang-ruby'>
// You probably use erb or haml, this is just plain ruby
if x_message
  var x_messages = x_messages.to_json.html_safe
end
</pre>
<p>Make sure to update the manifest for the JS files and include Alertify.js, then lets start handling the response for AJAX requests.</p>

<p>This function reads the header from the XHR response and parses the content in <code>X-Messages</code> as JSON.</p>
<pre class='prettyprint'>
var get_x_messages = function(response) {

  var x_messages_header =
    response.getResponseHeader('X-Messages');

  // Parse the header if there is one
  if (typeof x_messages_header !== "undefined") {
    return $.parseJSON(x_messages_header)
  }
}
</pre>
<p>This is a pretty straight-forward function for creating an Alertify log message for each message in the parse <code>X-Messages</code> header.</p>
<pre class='prettyprint'>
// For each message, alert the user
var handle_messages = function(messages) {
  $.each(messages, function(type, message) {
    alertify.log(message, type);
  });
}
</pre>
<p>This function is the main way we intercept the headers when they are returned to the client. This allows us to watch for ajax events, and when they are done handle the response with the first function we created, <code>get_x_messages()</code>.</p>
<pre class='prettyprint'>
// Get messages from response header
$(document).ajaxComplete(function(event, response) {
  handle_messages(get_x_messages(response))
});
</pre>
<p>Lastly when the DOM is loaded we want to hide (or <code>remove()</code> for simplicty) the flash messages that were rendered in the page.</p>

<p>Meanwhile, we also want to see if there are messages on the page that just loaded, and since the reponse would be for standard HTML, we wouln&#8217;t have the XHR object available to us. This stems from the way the DOM and BOM were created to seperate the two. There would be no real way to read the response headers &#8220;after the fact&#8221; with JavaScript, unless we made another request to our current path with XHR. The solution I found was to render the messages in the application layout as a JSON object.</p>
<pre class='prettyprint'>
$(function() {

  // hide these since we have alertify to show our messages
  $('.x-messages').remove();

  if (typeof x_messages !== "undefined") {
    handle_messages(x_messages);
  }
})
</pre>
<p>This allows us to handle existing errors that come with the page&#8217;s response, and any subsequent responses from remote requests in the same way. This is because the reponses made while already on the page with XHR will be caught by the <code>ajaxComplete()</code> event handler and the other ones will be handled when the page loaded.</p>
</div>

<div id="chattyloo"></div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
	  <li><a href="/posts/x-messages-slides">X-Messages Slides</a> &mdash; 26 Feb 2013</li>
    
	  <li><a href="/posts/device-orientation">Device Orientation Events</a> &mdash; 20 Nov 2012</li>
    
	  <li><a href="/posts/building-a-simple-html5-framework">Building a Simple HTML5 Framework</a> &mdash; 18 Sep 2012</li>
    
  </ul>
</div>

<script type="text/javascript">
  var currentUrl = window.location.pathname.replace("/","-")
  var chattyloo = document.createElement("iframe");

  chattyloo.setAttribute("src", "http://chattyloo.com/" + currentUrl + "?embed=true");
  chattyloo.setAttribute("height", "100%");
  chattyloo.setAttribute("width", "100%");

  document.getElementById('chattyloo').appendChild(chattyloo);
</script>

    </section>

    <footer>
      <p>Follow me on <a href="http://github.com/jpsilvashy">Github</a>, <a href="http://twitter.com/jpsilvashy">Twitter</a>, and <a href="http://stackoverflow.com/users/103739/joseph-silvashy">Stack Overflow</a>. Fork my blog on <a href="http://github.com/jpsilvashy/jpsilvashy.github.com">Github</a>.</p>
    </footer>
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
  <script src="/javascripts/scale.fix.js"></script>
  <script src="/javascripts/prettify.js"></script>
  <script src="/javascripts/main.js"></script>

  <!-- Asynchronous Google Analytics snippet. Change UA-XXXXX-X to be your site's ID. mathiasbynens.be/notes/async-analytics-snippet -->
  <script>
    var _gaq=[['_setAccount','UA-33729498-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
</body>
</html>